#!/usr/bin/env bash
# Git pre-commit hook for Rust project
set -e

# Set up PATH for Rust tools
export PATH="$HOME/.cargo/bin:/usr/local/bin:/opt/homebrew/bin:$PATH"

echo "ğŸ”§ Running pre-commit checks..."

# Check prerequisites
if [ ! -f "Cargo.toml" ]; then
    echo "âŒ Not a Rust project"
    exit 1
fi

if ! command -v cargo >/dev/null 2>&1; then
    echo "âŒ cargo not found"
    exit 1
fi

# Check for and clean up any stuck cargo processes
echo "ğŸ§¹ Checking for stuck cargo processes..."
if pgrep -f "cargo.*clippy\|cargo.*check\|cargo.*build" >/dev/null 2>&1; then
    echo "âš ï¸  Found stuck cargo processes, cleaning up..."
    pkill -f "cargo.*clippy\|cargo.*check\|cargo.*build" >/dev/null 2>&1 || true
    sleep 2
fi

# Function to check if files were modified
files_modified() {
    ! git diff --quiet --exit-code
}

# 1. Formatting
echo "ğŸ“ Checking formatting..."
if ! timeout 30 cargo fmt --all --check >/dev/null 2>&1; then
    echo "âš ï¸  Fixing formatting..."
    timeout 30 cargo fmt --all
    if files_modified; then
        git add -u
        echo "âœ… Formatting fixed and staged"
    fi
else
    echo "âœ… Formatting OK"
fi

# 2. Clippy check with auto-fixing
echo "ğŸ” Checking and fixing clippy issues..."
if ! timeout 30 cargo clippy --all-targets --all-features --quiet -- -D warnings >/dev/null 2>&1; then
    echo "âš ï¸  Clippy issues found. Attempting auto-fix..."
    
    # Try to auto-fix clippy issues
    if timeout 60 cargo clippy --fix --all-targets --all-features --allow-dirty --allow-staged >/dev/null 2>&1; then
        echo "âœ… Some clippy issues fixed automatically"
        
        if files_modified; then
            # Stage the fixed files
            git add -u
            echo "ï¿½ Fixed files have been staged for commit"
        fi
    fi
    
    # Check if there are still unfixable issues
    if ! timeout 30 cargo clippy --all-targets --all-features --quiet -- -D warnings >/dev/null 2>&1; then
        echo "âŒ Clippy issues remain that require manual fixing"
        echo "ğŸ’¡ Run: cargo clippy --all-targets --all-features"
        exit 1
    else
        echo "âœ… All clippy issues resolved"
    fi
else
    echo "âœ… Clippy OK"
fi

# 3. Build check
echo "ğŸ”¨ Checking build..."
if timeout 60 cargo build --all-features --quiet >/dev/null 2>&1; then
    echo "âœ… Build OK"
elif [ $? -eq 124 ]; then
    echo "âŒ Build timed out (may indicate compilation issues)"
    exit 1
else
    echo "âŒ Build failed"
    exit 1
fi

# 4. Quick tests (nextest)
echo "ğŸ§ª Running tests (nextest)..."
if command -v cargo-nextest >/dev/null 2>&1; then
    tmp_nextest=$(mktemp -t lotar-nextest.XXXXXX)
    trap 'rm -f "$tmp_nextest"' EXIT
    if timeout 120 cargo nextest run --all-features --failure-output immediate --status-level fail >"$tmp_nextest" 2>&1; then
        echo "âœ… Tests OK"
        rm -f "$tmp_nextest"
        trap - EXIT
    elif [ $? -eq 124 ]; then
        echo "âŒ Tests timed out"
        echo "--- cargo nextest output ---"
        cat "$tmp_nextest"
        rm -f "$tmp_nextest"
        trap - EXIT
        exit 1
    else
        echo "âŒ Tests failed"
        echo "--- cargo nextest output ---"
        cat "$tmp_nextest"
        rm -f "$tmp_nextest"
        trap - EXIT
        exit 1
    fi
else
    echo "âš ï¸  cargo-nextest not installed; falling back to cargo test"
    tmp_cargotest=$(mktemp -t lotar-cargotest.XXXXXX)
    trap 'rm -f "$tmp_cargotest"' EXIT
    if timeout 120 cargo test --all-features >"$tmp_cargotest" 2>&1; then
        echo "âœ… Tests OK"
        rm -f "$tmp_cargotest"
        trap - EXIT
    elif [ $? -eq 124 ]; then
        echo "âŒ Tests timed out"
        echo "--- cargo test output ---"
        cat "$tmp_cargotest"
        rm -f "$tmp_cargotest"
        trap - EXIT
        exit 1
    else
        echo "âŒ Tests failed"
        echo "--- cargo test output ---"
        cat "$tmp_cargotest"
        rm -f "$tmp_cargotest"
        trap - EXIT
        exit 1
    fi
fi

echo "ğŸ‰ All checks passed!"
